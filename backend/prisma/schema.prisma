// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELOS
// ============================================

enum UserRole {
  ADMIN
  APPROVER
  RELATOR
  VALIDATOR
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum TableType {
  JET_15
  JET_10
  FLY_10
  PLATINUM
  VIP
  GENERAL
}

enum PaymentType {
  CASH
  TRANSFER
  CARD
  FREE
}

enum PassStatus {
  ACTIVE
  USED
  REVOKED
}

// Usuario del sistema
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  role      UserRole @default(RELATOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  reservationsAsRelator     Reservation[]    @relation("RelatorReservations")
  reservationsAsSupport     Reservation[]    @relation("SupportReservations")
  approvalsGiven            Approval[]
  sectorsAsApprover         Sector[]         @relation("SectorApprovers")
  notificationsSent         Notification[]   @relation("SenderNotifications")
  notificationsReceived     Notification[]   @relation("ReceiverNotifications")
  qrValidations             QRValidation[]
  additionalPassesCreated   AdditionalPass[] @relation("CreatedByUser")
  auditLogs                 AuditLog[]

  @@map("User")
}

// Evento
model Event {
  id          String        @id @default(uuid())
  name        String
  description String?
  eventDate   DateTime
  location    String?
  maxCapacity Int?
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relaciones
  reservations Reservation[]

  @@map("Event")
}

// Sector del evento
model Sector {
  id                String   @id @default(uuid())
  name              String
  code              String   @unique
  description       String?
  capacity          Int?
  requiresApproval  Boolean  @default(false)
  active            Boolean  @default(true)
  color             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  reservations Reservation[]
  approvers    User[]        @relation("SectorApprovers")

  @@map("Sector")
}

// Reserva
model Reservation {
  id                String            @id @default(uuid())
  eventId           String
  sectorId          String
  tableType         TableType
  responsibleName   String
  responsiblePhone  String
  responsibleEmail  String?
  responsibleCI     String?
  observations      String?
  status            ReservationStatus @default(PENDING)
  paymentType       PaymentType?
  paymentAmount     Float?
  relatorMainId     String
  relatorSupportId  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relaciones
  event            Event             @relation(fields: [eventId], references: [id])
  sector           Sector            @relation(fields: [sectorId], references: [id])
  relatorMain      User              @relation("RelatorReservations", fields: [relatorMainId], references: [id])
  relatorSupport   User?             @relation("SupportReservations", fields: [relatorSupportId], references: [id])
  guests           Guest[]
  approvals        Approval[]
  notifications    Notification[]
  qrValidations    QRValidation[]
  additionalPasses AdditionalPass[]
  transfersFrom    Transfer[]        @relation("TransferFrom")
  transfersTo      Transfer[]        @relation("TransferTo")

  @@map("Reservation")
}

// Invitado
model Guest {
  id            String    @id @default(uuid())
  reservationId String
  name          String
  ci            String?
  phone         String?
  qrCode        String    @unique
  qrValidated   Boolean   @default(false)
  validatedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  reservation   Reservation    @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  qrValidations QRValidation[]

  @@map("Guest")
}

// Aprobación
model Approval {
  id            String   @id @default(uuid())
  reservationId String
  approverId    String
  approved      Boolean
  comments      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  reservation Reservation @relation(fields: [reservationId], references: [id])
  approver    User        @relation(fields: [approverId], references: [id])

  @@map("Approval")
}

// Notificación
model Notification {
  id           String   @id @default(uuid())
  type         String
  title        String
  message      String
  senderId     String?
  receiverId   String?
  reservationId String?
  read         Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  sender      User?        @relation("SenderNotifications", fields: [senderId], references: [id])
  receiver    User?        @relation("ReceiverNotifications", fields: [receiverId], references: [id])
  reservation Reservation? @relation(fields: [reservationId], references: [id])

  @@map("Notification")
}

// Validación de QR
model QRValidation {
  id            String   @id @default(uuid())
  reservationId String?
  guestId       String?
  passId        String?
  validatedBy   String
  validatedAt   DateTime @default(now())
  location      String?
  deviceInfo    String?

  // Relaciones
  reservation     Reservation?    @relation(fields: [reservationId], references: [id])
  guest           Guest?          @relation(fields: [guestId], references: [id])
  additionalPass  AdditionalPass? @relation(fields: [passId], references: [id])
  validator       User            @relation(fields: [validatedBy], references: [id])

  @@map("QRValidation")
}

// Pases adicionales
model AdditionalPass {
  id            String     @id @default(uuid())
  reservationId String
  guestName     String
  guestCI       String?
  guestPhone    String?
  reason        String
  qrCode        String     @unique
  status        PassStatus @default(ACTIVE)
  qrValidated   Boolean    @default(false)
  validatedAt   DateTime?
  createdById   String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relaciones
  reservation   Reservation    @relation(fields: [reservationId], references: [id])
  createdBy     User           @relation("CreatedByUser", fields: [createdById], references: [id])
  qrValidations QRValidation[]

  @@map("AdditionalPass")
}

// Configuración del sitio
model SiteSettings {
  id                    String   @id @default(uuid())
  siteName              String   @default("Sistema de Reservas")
  logoUrl               String?
  faviconUrl            String?
  primaryColor          String   @default("#3B82F6")
  secondaryColor        String   @default("#10B981")
  contactEmail          String?
  contactPhone          String?
  facebookUrl           String?
  instagramUrl          String?
  twitterUrl            String?
  whatsappNumber        String?
  termsAndConditions    String?
  maxGuestsPerTable     Int      @default(15)
  requireApproval       Boolean  @default(true)
  allowSelfRegistration Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("SiteSettings")
}

// Transferencias de mesas
model Transfer {
  id              String   @id @default(uuid())
  fromReservation String
  toReservation   String
  transferredBy   String
  reason          String?
  guestsCount     Int
  createdAt       DateTime @default(now())

  // Relaciones
  from Reservation @relation("TransferFrom", fields: [fromReservation], references: [id])
  to   Reservation @relation("TransferTo", fields: [toReservation], references: [id])

  @@map("Transfer")
}

// Auditoría
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  changes   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relaciones
  user User? @relation(fields: [userId], references: [id])

  @@map("AuditLog")
}
PRISMA_SCHEMA